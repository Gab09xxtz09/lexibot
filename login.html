<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login Discord</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    .discord-btn {
      background-color: #5865F2;
      border-color: #5865F2;
      transition: all 0.3s ease;
    }
    .discord-btn:hover {
      background-color: #4752C4;
      border-color: #4752C4;
      transform: translateY(-2px);
    }
    .card {
      max-width: 400px;
      border: none;
      border-radius: 15px;
    }
    .loading {
      display: none;
    }
    .error-message {
      display: none;
      margin-top: 15px;
    }
  </style>
</head>
<body class="d-flex flex-column justify-content-center align-items-center vh-100 bg-light">
  <div class="card p-4 shadow-lg">
    <div class="text-center mb-4">
      <i class="fab fa-discord fa-3x text-primary mb-3"></i>
      <h2 class="mb-3">Accedi con Discord</h2>
      <p class="text-muted">Clicca sul pulsante per autenticarti tramite Discord</p>
    </div>
    
    <button id="discord-login" class="btn discord-btn text-white w-100 py-3">
      <i class="fab fa-discord me-2"></i> 
      <span class="login-text">Login con Discord</span>
      <span class="loading">
        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        Reindirizzamento...
      </span>
    </button>
    
    <div id="error-message" class="alert alert-danger error-message" role="alert">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <span id="error-text"></span>
    </div>
    
    <!-- Debug info (rimuovi in produzione) -->
    <div class="mt-3 small text-muted">
      <div id="debug-info"></div>
    </div>
  </div>

  <script>
    // Configurazione Discord OAuth
    const CLIENT_ID = '1403753422351630459'; // Il tuo client ID
    
    // IMPORTANTE: Questo URL deve corrispondere ESATTAMENTE a quello configurato su Discord
    // Configura qui l'URL esatto che hai impostato nel Discord Developer Portal
    const REDIRECT_URI = window.location.origin + '/home/index.html';
    
    // Se stai testando in locale, usa questo:
    // const REDIRECT_URI = 'http://localhost:3000/home/index.html';
    
    // Oppure se hai una pagina dedicata per il callback:
    // const REDIRECT_URI = window.location.origin + '/callback.html';
    const SCOPES = ['identify', 'email']; // Aggiungi gli scope necessari
    
    // Costruisci l'URL di autorizzazione Discord
    const buildDiscordAuthUrl = () => {
      const params = new URLSearchParams({
        client_id: CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        response_type: 'token', // o 'code' se preferisci il flow del codice
        scope: SCOPES.join(' '),
        state: generateState() // Per sicurezza
      });
      
      return `https://discord.com/oauth2/authorize?${params.toString()}`;
    };
    
    // Genera un state casuale per sicurezza
    function generateState() {
      return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    }
    
    // Funzione per mostrare errori
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      errorText.textContent = message;
      errorDiv.style.display = 'block';
    }
    
    // Funzione per nascondere errori
    function hideError() {
      document.getElementById('error-message').style.display = 'none';
    }
    
    // Funzione per mostrare/nascondere il loading
    function toggleLoading(show) {
      const button = document.getElementById('discord-login');
      const loginText = button.querySelector('.login-text');
      const loadingText = button.querySelector('.loading');
      
      if (show) {
        loginText.style.display = 'none';
        loadingText.style.display = 'inline-block';
        button.disabled = true;
      } else {
        loginText.style.display = 'inline-block';
        loadingText.style.display = 'none';
        button.disabled = false;
      }
    }
    
    // Debug info
    function updateDebugInfo() {
      const debugDiv = document.getElementById('debug-info');
      debugDiv.innerHTML = `
        <strong>⚠️ CONFIGURAZIONE RICHIESTA:</strong><br>
        Nel Discord Developer Portal, in "OAuth2 > Redirects", aggiungi ESATTAMENTE questo URL:<br>
        <code style="background: #f8f9fa; padding: 2px 4px; border-radius: 4px;">${REDIRECT_URI}</code><br><br>
        <strong>Debug Info:</strong><br>
        Client ID: ${CLIENT_ID}<br>
        Redirect URI: ${REDIRECT_URI}<br>
        Current URL: ${window.location.href}
      `;
    }
    
    // Gestione del click sul pulsante di login
    document.getElementById('discord-login').onclick = function(e) {
      e.preventDefault();
      hideError();
      
      try {
        toggleLoading(true);
        
        // Salva lo state nel localStorage per verifica successiva
        const state = generateState();
        localStorage.setItem('discord_oauth_state', state);
        
        // Costruisci l'URL con il nuovo state
        const authUrl = buildDiscordAuthUrl().replace(/state=[^&]*/, `state=${state}`);
        
        console.log('Reindirizzamento a:', authUrl);
        
        // Reindirizza a Discord
        setTimeout(() => {
          window.location.href = authUrl;
        }, 500);
        
      } catch (error) {
        console.error('Errore durante il reindirizzamento:', error);
        showError('Errore durante il reindirizzamento a Discord. Riprova.');
        toggleLoading(false);
      }
    };
    
    // Controlla se siamo tornati da Discord con un token
    function checkForDiscordCallback() {
      const hash = window.location.hash;
      
      if (hash && hash.includes('access_token')) {
        // Parsing dei parametri dall'hash
        const params = new URLSearchParams(hash.substring(1));
        const accessToken = params.get('access_token');
        const tokenType = params.get('token_type');
        const expiresIn = params.get('expires_in');
        const scope = params.get('scope');
        const state = params.get('state');
        
        // Verifica lo state per sicurezza
        const savedState = localStorage.getItem('discord_oauth_state');
        if (state !== savedState) {
          showError('Errore di sicurezza: state non valido');
          return;
        }
        
        if (accessToken) {
          console.log('Token ricevuto:', accessToken);
          
          // Qui puoi fare la chiamata API per ottenere le info dell'utente
          fetchUserInfo(accessToken)
            .then(userInfo => {
              console.log('Informazioni utente:', userInfo);
              // Reindirizza alla tua pagina principale o salva i dati
              // window.location.href = '/home/index.html';
              alert(`Benvenuto ${userInfo.username}! Login effettuato con successo.`);
            })
            .catch(error => {
              console.error('Errore nel recupero info utente:', error);
              showError('Errore nel recupero delle informazioni utente');
            });
        }
      }
    }
    
    // Funzione per ottenere le info dell'utente da Discord
    async function fetchUserInfo(accessToken) {
      try {
        const response = await fetch('https://discord.com/api/users/@me', {
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        throw new Error(`Errore API Discord: ${error.message}`);
      }
    }
    
    // Inizializzazione
    document.addEventListener('DOMContentLoaded', function() {
      updateDebugInfo();
      checkForDiscordCallback();
    });
  </script>
</body>
</html>
